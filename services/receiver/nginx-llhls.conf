worker_processes auto;
rtmp_auto_push on;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

# RTMP 服務器配置
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        
        # 全局設置
        buflen 1s;
        idle_streams off;
        drop_idle_publisher 10s;

        # 直播應用 - LL-HLS 版本
        application live {
            live on;
            record off;
            
            # 允許所有來源推流和播放
            allow publish all;
            allow play all;
            
            # 原生 LL-HLS 輸出 (超低延遲)
            hls on;
            hls_path /tmp/hls;
            hls_fragment 1s;              # 1秒片段，減少延遲
            hls_playlist_length 5s;       # 5秒播放列表，減少緩衝
            hls_nested on;
            hls_cleanup on;
            hls_fragment_naming sequential;
            hls_fragment_slicing aligned;
            hls_continuous on;            # 連續播放
            hls_sync 100ms;               # 同步時間戳
            
            # LL-HLS 特定配置
            # 注意：nginx-rtmp 的 hls_variant 語法有限制，這裡使用基本配置
            
            # 事件回調 (暫時禁用，因為 stream-puller 現在只處理外部流)
            # on_publish http://stream-puller:8081/rtmp/publish;
            # on_publish_done http://stream-puller:8081/rtmp/publish_done;
            # on_error http://stream-puller:8081/rtmp/error;
        }
        
        # 備用應用 (標準 HLS，用於兼容性)
        application live_standard {
            live on;
            record off;
            
            allow publish all;
            allow play all;
            
            # 標準 HLS 輸出
            hls on;
            hls_path /tmp/hls_standard;
            hls_fragment 2s;
            hls_playlist_length 10s;
            hls_nested on;
            hls_cleanup on;
        }
    }
}

# 注意：HTTP 服務器部分已移除，HLS 文件由 live-cdn 服務提供 
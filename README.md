# ğŸ¬ ä¸²æµå¹³å°å°ˆæ¡ˆ

## ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°

ç¾ä»£åŒ–å…¨æ£§ä¸²æµå¹³å°ï¼Œæä¾›å½±ç‰‡ä¸Šå‚³ã€è‡ªå‹•è½‰ç¢¼ã€ç›´æ’­å’Œç”¨æˆ¶ç®¡ç†åŠŸèƒ½ã€‚æ¡ç”¨ **PostgreSQL + Redis æ··åˆæ¶æ§‹**ï¼Œæ•´åˆ **MinIO å°è±¡å­˜å„²** å’Œ **FFmpeg æœ¬åœ°è½‰ç¢¼**ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹è‰²
- âœ… **æ··åˆæ¶æ§‹**: PostgreSQL ä¸»è³‡æ–™åº« + Redis ç·©å­˜èˆ‡è¨Šæ¯
- âœ… **æ™ºèƒ½è½‰ç¢¼**: èƒŒæ™¯æœå‹™è‡ªå‹•ç”Ÿæˆå¤šå“è³ª HLS å’Œ MP4
- âœ… **é›™æ¡¶å­˜å„²**: åŸå§‹æª”æ¡ˆèˆ‡è½‰ç¢¼å¾Œæª”æ¡ˆåˆ†é›¢
- âœ… **ç›´æ’­ç³»çµ±**: å¤–éƒ¨æµæ‹‰å– + ä½å»¶é²æ’­æ”¾
- âœ… **å³æ™‚é€šä¿¡**: WebSocket + Redis Pub/Sub
- âœ… **ç¾ä»£å‰ç«¯**: Vue 3 + TypeScript + Element Plus
- âœ… **å®Œæ•´ Docker**: ä¸€éµå•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
- âœ… **æ¨¡çµ„åŒ–æ¶æ§‹**: ä¾è³´æ³¨å…¥ + çµ±ä¸€è·¯ç”±ç®¡ç†

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹

```
å‰ç«¯ (Vue 3) â†’ å¾Œç«¯ (Go/Gin) â†’ è³‡æ–™åº« (PostgreSQL + Redis) â†’ å­˜å„² (MinIO) â†’ è½‰ç¢¼ (FFmpeg)
```

### æŠ€è¡“æ£§
- **å‰ç«¯**: Vue 3, TypeScript, Element Plus, hls.js
- **å¾Œç«¯**: Go 1.24.3, Gin, GORM, JWT, ä¾è³´æ³¨å…¥
- **è³‡æ–™åº«**: PostgreSQL 15, Redis 7, MySQL 8.0
- **å­˜å„²**: MinIO (S3 å…¼å®¹)
- **è½‰ç¢¼**: FFmpeg 6.0.1
- **å®¹å™¨**: Docker & Docker Compose

## ğŸ›ï¸ å¾Œç«¯æ¶æ§‹è¨­è¨ˆ

### æ¨¡çµ„åŒ–æ¶æ§‹
```
backend/
â”œâ”€â”€ main.go (ç°¡åŒ–å…¥å£)
â”œâ”€â”€ api/ (çµ±ä¸€ API å±¤)
â”‚   â”œâ”€â”€ router.go (è·¯ç”±ç®¡ç†å™¨)
â”‚   â”œâ”€â”€ user.go, video.go, live.go, payment.go
â”‚   â””â”€â”€ public_stream.go
â”œâ”€â”€ di/ (ä¾è³´æ³¨å…¥)
â”‚   â””â”€â”€ container.go (ä¾è³´ç®¡ç†å®¹å™¨)
â”œâ”€â”€ services/ (æ¥­å‹™é‚è¼¯å±¤)
â”œâ”€â”€ database/ (è³‡æ–™åº«å±¤)
â”œâ”€â”€ repositories/ (è³‡æ–™è¨ªå•å±¤)
â”œâ”€â”€ dto/ (è³‡æ–™å‚³è¼¸å°è±¡)
â”œâ”€â”€ middleware/ (ä¸­é–“ä»¶)
â”œâ”€â”€ utils/ (å·¥å…·å‡½æ•¸)
â”œâ”€â”€ pkg/ (å…¬å…±åŒ…)
â”œâ”€â”€ config/ (é…ç½®ç®¡ç†)
â”œâ”€â”€ ws/ (WebSocket)
â””â”€â”€ tests/ (æ¸¬è©¦)
```

### è¨­è¨ˆæ¨¡å¼
- **çµ„åˆæ¨¡å¼**: Router çµ„åˆæ‰€æœ‰ Handler
- **å·¥å» æ¨¡å¼**: Container å·¥å» å‰µå»ºæœå‹™å¯¦ä¾‹
- **ä¾è³´æ³¨å…¥**: çµ±ä¸€ç®¡ç†æ‰€æœ‰ä¾è³´é—œä¿‚

## ğŸ“ˆ æ ¸å¿ƒæœå‹™æµç¨‹

### å½±ç‰‡ä¸Šå‚³èˆ‡è‡ªå‹•è½‰æª”æµç¨‹
```mermaid
sequenceDiagram
    participant U as ç”¨æˆ¶
    participant FE as å‰ç«¯
    participant BE as å¾Œç«¯
    participant MINIO_ORIG as MinIO åŸå§‹æ¡¶
    participant MINIO_PROC as MinIO è™•ç†æ¡¶
    participant FFMPEG as FFmpeg è½‰ç¢¼å™¨
    participant DB as PostgreSQL
    participant TW as è½‰ç¢¼èƒŒæ™¯æœå‹™
    
    U->>FE: é¸æ“‡å½±ç‰‡æª”æ¡ˆ
    FE->>BE: è«‹æ±‚ä¸Šå‚³ URL
    BE->>BE: é©—è­‰æª”æ¡ˆæ ¼å¼/å¤§å°
    BE->>MINIO_ORIG: ç”Ÿæˆé ç°½å URL
    MINIO_ORIG-->>BE: è¿”å›ä¸Šå‚³ URL
    BE-->>FE: è¿”å›ä¸Šå‚³ URL å’Œ Key
    FE->>MINIO_ORIG: ç›´æ¥ä¸Šå‚³æª”æ¡ˆ
    MINIO_ORIG-->>FE: ä¸Šå‚³å®Œæˆ
    FE->>BE: ç¢ºèªä¸Šå‚³å®Œæˆ
    BE->>DB: å‰µå»ºå½±ç‰‡è¨˜éŒ„ (status: uploading)
    BE->>TW: å•Ÿå‹•ç•°æ­¥è½‰ç¢¼
    
    Note over TW: èƒŒæ™¯æœå‹™ç›£æ§
    TW->>DB: SELECT FOR UPDATE æŸ¥è©¢å¾…è½‰ç¢¼å½±ç‰‡
    DB-->>TW: è¿”å›å¾…è™•ç†å½±ç‰‡åˆ—è¡¨
    
    loop æ¯å€‹å¾…è½‰ç¢¼å½±ç‰‡
        TW->>FFMPEG: è§¸ç™¼è½‰ç¢¼ä»»å‹™
        FFMPEG->>MINIO_ORIG: ä¸‹è¼‰åŸå§‹å½±ç‰‡
        MINIO_ORIG-->>FFMPEG: è¿”å›å½±ç‰‡æª”æ¡ˆ
        
        FFMPEG->>FFMPEG: å¤šå“è³ªè½‰ç¢¼è™•ç†
        Note right of FFMPEG: 720p, 480p, 360p HLS<br/>MP4 ç¶²é ç‰ˆæœ¬<br/>ç¸®åœ–ç”Ÿæˆ
        
        FFMPEG->>MINIO_PROC: ä¸Šå‚³è½‰ç¢¼çµæœ
        MINIO_PROC-->>FFMPEG: ä¸Šå‚³å®Œæˆ
        FFMPEG-->>TW: è½‰ç¢¼å®Œæˆé€šçŸ¥
        
        TW->>DB: æ›´æ–°å½±ç‰‡ç‹€æ…‹ (status: ready)
        TW->>DB: å‰µå»ºå“è³ªè¨˜éŒ„
    end
    
    BE->>FE: å›æ‡‰ä¸Šå‚³ç¢ºèªæˆåŠŸ
    FE->>U: é¡¯ç¤ºä¸Šå‚³æˆåŠŸï¼Œæç¤ºå¯èƒ½æ­£åœ¨è½‰ç¢¼
```

### ç›´æ’­æµç³»çµ±æ¶æ§‹
```mermaid
graph TB
    subgraph "å¤–éƒ¨æµæº"
        A[NASA Live]
        B[æ–°èå°]
        C[æ¸¬è©¦æµ]
    end
    
    subgraph "Stream Puller æœå‹™"
        D[FFmpeg æ‹‰æµ]
        E[HLS è½‰æ›]
        F[RTMP è½‰æ›]
    end
    
    subgraph "æ’­æ”¾æœå‹™"
        G[HLS æ’­æ”¾å™¨]
        H[WebRTC æ’­æ”¾å™¨]
    end
    
    subgraph "å‰ç«¯æ‡‰ç”¨"
        I[Vue 3 å‰ç«¯]
        J[WebSocket èŠå¤©]
    end
    
    A --> D
    B --> D
    C --> D
    D --> E
    D --> F
    E --> G
    F --> G
    G --> I
    H --> I
    I --> J
```

### å‰ç«¯æ™ºèƒ½æ’­æ”¾æµç¨‹
```mermaid
sequenceDiagram
    participant U as ç”¨æˆ¶
    participant FE as å‰ç«¯
    participant BE as å¾Œç«¯ API
    participant SP as Stream Puller
    participant HLS as HLS.js
    
    U->>FE: é¸æ“‡ç›´æ’­æµ
    FE->>BE: ç²å–æµä¿¡æ¯
    BE-->>FE: è¿”å›æµåˆ—è¡¨å’Œ URL
    
    FE->>FE: åˆå§‹åŒ– HLS.js
    FE->>SP: è«‹æ±‚ HLS æ’­æ”¾åˆ—è¡¨
    SP-->>FE: è¿”å› index.m3u8
    
    FE->>HLS: è¼‰å…¥æ’­æ”¾åˆ—è¡¨
    HLS->>SP: è«‹æ±‚å“è³ªé¸æ“‡
    SP-->>HLS: è¿”å›å¯ç”¨å“è³ª
    
    HLS->>HLS: è‡ªå‹•é¸æ“‡æœ€ä½³å“è³ª
    HLS->>SP: è«‹æ±‚å½±ç‰‡ç‰‡æ®µ
    SP-->>HLS: è¿”å› .ts ç‰‡æ®µ
    
    HLS->>FE: é–‹å§‹æ’­æ”¾
    FE->>U: é¡¯ç¤ºç›´æ’­å…§å®¹
    
    Note over FE: æ™ºèƒ½å“è³ªåˆ‡æ›
    FE->>FE: ç›£æ§ç¶²è·¯ç‹€æ³
    alt ç¶²è·¯è‰¯å¥½
        FE->>HLS: åˆ‡æ›åˆ°é«˜å“è³ª
    else ç¶²è·¯ä¸ä½³
        FE->>HLS: åˆ‡æ›åˆ°ä½å“è³ª
    end
    
    U->>FE: æ‰‹å‹•åˆ‡æ›å“è³ª
    FE->>FE: é‡æ–°è¼‰å…¥å°æ‡‰å“è³ª
    FE->>U: é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    FE->>U: æ’­æ”¾æ–°å“è³ª
```

### æª”æ¡ˆå­˜å„²çµæ§‹
```
MinIO Bucket: stream-demo-videos/ (åŸå§‹æª”æ¡ˆ)
â”œâ”€â”€ videos/
â”‚   â””â”€â”€ original/              # åŸå§‹ä¸Šå‚³æª”æ¡ˆ
â”‚       â””â”€â”€ {user_id}/
â”‚           â””â”€â”€ {uuid}.{ext}   # ä¾‹ï¼š431254c8-6bdc-4137-969b-5fa3d9ae9788.mov

MinIO Bucket: stream-demo-processed/ (è½‰ç¢¼å¾Œæª”æ¡ˆ)
â”œâ”€â”€ videos/
â”‚   â””â”€â”€ processed/             # è½‰ç¢¼å¾Œæª”æ¡ˆ
â”‚       â””â”€â”€ {user_id}/
â”‚           â””â”€â”€ {video_id}/
â”‚               â”œâ”€â”€ video.mp4                    # MP4 æ’­æ”¾ç‰ˆæœ¬
â”‚               â”œâ”€â”€ hls/                        # HLS ä¸²æµ
â”‚               â”‚   â”œâ”€â”€ index.m3u8              # ä¸»æ’­æ”¾åˆ—è¡¨
â”‚               â”‚   â”œâ”€â”€ 720p/
â”‚               â”‚   â”‚   â”œâ”€â”€ index.m3u8
â”‚               â”‚   â”‚   â””â”€â”€ segment_*.ts
â”‚               â”‚   â”œâ”€â”€ 480p/
â”‚               â”‚   â”‚   â”œâ”€â”€ index.m3u8
â”‚               â”‚   â”‚   â””â”€â”€ segment_*.ts
â”‚               â”‚   â””â”€â”€ 360p/
â”‚               â”‚       â”œâ”€â”€ index.m3u8
â”‚               â”‚       â””â”€â”€ segment_*.ts
â”‚               â”œâ”€â”€ thumbnails/                 # ç¸®åœ–
â”‚               â”‚   â”œâ”€â”€ thumb_320x240.jpg
â”‚               â”‚   â”œâ”€â”€ thumb_640x480.jpg
â”‚               â”‚   â”œâ”€â”€ thumb_1280x720.jpg
â”‚               â”‚   â””â”€â”€ timeline_*.jpg          # æ™‚é–“è»¸ç¸®åœ–
â”‚               â””â”€â”€ transcode_report.json       # è½‰ç¢¼å ±å‘Š
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### ç’°å¢ƒè¦æ±‚
- Docker & Docker Compose
- Go 1.24.3+
- Node.js 18+

### å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ

```bash
# å…‹éš†å°ˆæ¡ˆ
git clone <repository-url>
cd stream-demo

# å•Ÿå‹•æ‰€æœ‰æœå‹™
docker-compose up -d

# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker-compose ps
```

### æœå‹™ç«¯å£

| æœå‹™ | ç«¯å£ | æè¿° |
|------|------|------|
| PostgreSQL | 5432 | ä¸»è³‡æ–™åº« |
| Redis | 6379 | ç·©å­˜èˆ‡è¨Šæ¯ |
| MinIO API | 9000 | S3 å…¼å®¹ API |
| MinIO Console | 9001 | ç®¡ç†ç•Œé¢ |
| Go å¾Œç«¯ | 8080 | REST API |
| Vue å‰ç«¯ | 5173 | é–‹ç™¼ä¼ºæœå™¨ |
| Stream Puller | 8083 | HLS æ’­æ”¾æœå‹™ |

### åˆå§‹è¨­ç½®

```bash
# MinIO ç®¡ç†ç•Œé¢
http://localhost:9001
# å¸³è™Ÿ: minioadmin / minioadmin

# å‰µå»ºå„²å­˜æ¡¶
docker exec stream-demo-minio mc alias set local http://localhost:9000 minioadmin minioadmin
docker exec stream-demo-minio mc mb local/stream-demo-videos
docker exec stream-demo-minio mc mb local/stream-demo-processed
```

## ğŸ“Š åŠŸèƒ½å®Œæˆåº¦

### âœ… å·²å®Œæˆ (95%)
- **ç”¨æˆ¶èªè­‰**: è¨»å†Šã€ç™»å…¥ã€JWT
- **å½±ç‰‡ç³»çµ±**: ä¸Šå‚³ã€è½‰ç¢¼ã€æ’­æ”¾
- **ç›´æ’­ç³»çµ±**: æµæ‹‰å–ã€æ’­æ”¾ã€ç‹€æ…‹ç®¡ç†
- **æŠ€è¡“æ¶æ§‹**: APIã€å‰ç«¯ã€è³‡æ–™åº«ã€Docker
- **æ¶æ§‹é‡æ§‹**: ä¾è³´æ³¨å…¥ã€çµ±ä¸€è·¯ç”±ã€æ¨¡çµ„åŒ–è¨­è¨ˆ

### ğŸ”„ é€²è¡Œä¸­ (3%)
- **WebRTC çœŸå¯¦æ’­æ”¾**: éœ€è¦ä¿¡ä»¤æœå‹™å™¨

### ğŸ“‹ å¾…é–‹ç™¼ (2%)
- **ç›´æ’­é–“åŠŸèƒ½**: å¯¦æ™‚èŠå¤©ã€è§€çœ¾äº’å‹•
- **æ¨æµåŠŸèƒ½**: OBS/æ‰‹æ©Ÿæ¨æµæ”¯æ´
- **æ”¯ä»˜ç³»çµ±**: ç¬¬ä¸‰æ–¹æ”¯ä»˜æ•´åˆ
- **ç®¡ç†å¾Œå°**: ç³»çµ±ç®¡ç†ç•Œé¢

## ğŸ® ä½¿ç”¨æŒ‡å—

### å½±ç‰‡ä¸Šå‚³
1. ç™»å…¥ç³»çµ±
2. é€²å…¥å½±ç‰‡ä¸Šå‚³é é¢
3. é¸æ“‡æª”æ¡ˆä¸Šå‚³
4. ç³»çµ±è‡ªå‹•è½‰ç¢¼ (èƒŒæ™¯è™•ç†)
5. è½‰ç¢¼å®Œæˆå¾Œå¯æ’­æ”¾

### ç›´æ’­è§€çœ‹
1. è¨ªå•å…¬é–‹æµåˆ—è¡¨
2. é¸æ“‡ç›´æ’­æµ
3. æ”¯æ´ HLS æ’­æ”¾ (2-5ç§’å»¶é²)
4. é ç•™ WebRTC æ’­æ”¾ (è¶…ä½å»¶é²)

### é–‹ç™¼èª¿è©¦
```bash
# æŸ¥çœ‹è½‰ç¢¼æ—¥èªŒ
docker logs stream-demo-transcoder

# æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ (æ§åˆ¶å°è¼¸å‡º)
cd backend && go run main.go

# æ‰‹å‹•æ¸¬è©¦è½‰ç¢¼
docker exec stream-demo-transcoder /scripts/transcode.sh \
  "videos/original/1/test.mov" \
  "videos/processed/1/1" \
  "1" \
  "1"
```

## ğŸ› ï¸ é–‹ç™¼æŒ‡å—

### å°ˆæ¡ˆçµæ§‹
```
stream-demo/
â”œâ”€â”€ backend/          # Go å¾Œç«¯æœå‹™ (é‡æ§‹å®Œæˆ)
â”œâ”€â”€ frontend/         # Vue 3 å‰ç«¯æ‡‰ç”¨
â”œâ”€â”€ docker/           # Docker é…ç½®
â”œâ”€â”€ docker-compose.yml # æœå‹™ç·¨æ’
â””â”€â”€ README.md         # å°ˆæ¡ˆæ–‡æª”
```

### é–‹ç™¼æµç¨‹
1. ä¿®æ”¹å¾Œç«¯ä»£ç¢¼ â†’ `go run main.go`
2. ä¿®æ”¹å‰ç«¯ä»£ç¢¼ â†’ `npm run dev`
3. è³‡æ–™åº«è®Šæ›´ â†’ åŸ·è¡Œé·ç§»
4. æ¸¬è©¦åŠŸèƒ½ â†’ ä½¿ç”¨ Docker ç’°å¢ƒ

## ğŸ“‹ TODO æ¸…å–®

### é«˜å„ªå…ˆç´š
- [ ] **ç›´æ’­é–“åŠŸèƒ½**: å¯¦æ™‚èŠå¤©ã€è§€çœ¾äº’å‹•ã€ç¦®ç‰©ç³»çµ±
- [ ] **WebRTC ä¿¡ä»¤æœå‹™å™¨**: å¯¦ç¾çœŸæ­£çš„ WebRTC æ’­æ”¾
- [ ] **æ¨æµåŠŸèƒ½**: æ”¯æ´ OBS å’Œæ‰‹æ©Ÿæ¨æµ

### ä¸­å„ªå…ˆç´š
- [ ] **ç›´æ’­éŒ„è£½åŠŸèƒ½**: å°‡ç›´æ’­æµå­˜æª”ç‚º VOD
- [ ] **å¤šå“è³ªç›´æ’­**: æ”¯æ´ä¸åŒå“è³ªçš„ç›´æ’­æµ
- [ ] **å½ˆå¹•ç³»çµ±**: å¯¦æ™‚å½ˆå¹•é¡¯ç¤º

### ä½å„ªå…ˆç´š
- [ ] **æ”¯ä»˜ç³»çµ±**: ç¬¬ä¸‰æ–¹æ”¯ä»˜æ•´åˆ
- [ ] **ç®¡ç†å¾Œå°**: ç³»çµ±ç®¡ç†ç•Œé¢
- [ ] **æ•¸æ“šåˆ†æ**: ç”¨æˆ¶è¡Œç‚ºåˆ†æ

## ğŸš€ å¾®æœå‹™æº–å‚™

å°ˆæ¡ˆå·²ç‚ºå¾®æœå‹™æ¶æ§‹åšå¥½æº–å‚™ï¼š

1. **å‰ç«¯æœå‹™ (Vue)** - `frontend/` âœ…
2. **è³‡æ–™åº«æœå‹™** - `database/` âœ…
3. **è¨˜æ†¶é«”å„²å­˜æœå‹™ (Redis)** - é€šéé…ç½®ç®¡ç† âœ…
4. **å¾Œç«¯å¹³å°æœå‹™ (Golang)** - `backend/` âœ… (å·²é‡æ§‹)
5. **ç›´æ’­æ‹‰æµæœå‹™ (stream-puller)** - `cmd/stream_puller/` âœ…
6. **å½±ç‰‡å„²å­˜è½‰æª”æœå‹™** - å¯é…ç½®ç‚º AWS S3 âœ…

---

**ä¸‹ä¸€æ­¥**: é–‹å§‹é–‹ç™¼ç›´æ’­é–“åŠŸèƒ½ï¼ğŸ‰
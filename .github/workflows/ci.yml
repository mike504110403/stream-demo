name: CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  # 後端 Go 測試
  backend-test:
    runs-on: ubuntu-latest
    name: Backend Tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
    
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('services/api/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Install dependencies
      working-directory: ./services/api
      run: go mod download
    
    - name: Run tests
      working-directory: ./services/api
      env:
        STREAM_DEMO_DB_HOST: localhost
        STREAM_DEMO_DB_PORT: 5432
        STREAM_DEMO_DB_USER: postgres
        STREAM_DEMO_DB_PASSWORD: postgres
        STREAM_DEMO_DB_NAME: stream_demo_test
        STREAM_DEMO_REDIS_HOST: localhost
        STREAM_DEMO_REDIS_PORT: 6379
        STREAM_DEMO_JWT_SECRET: test_jwt_secret_for_ci
        STREAM_DEMO_S3_ACCESS_KEY: test_access_key
        STREAM_DEMO_S3_SECRET_KEY: test_secret_key
        STREAM_DEMO_LIVE_API_KEY: test_live_api_key
        STREAM_DEMO_LIVE_API_SECRET: test_live_api_secret
      run: |
        go test -v -race -coverprofile=coverage.out ./...
        go tool cover -func=coverage.out
    
    - name: Check test coverage
      working-directory: ./services/api
      run: |
        COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "Current coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 5" | bc -l) )); then
          echo "❌ Coverage is below 5% threshold (current: $COVERAGE%)"
          exit 1
        else
          echo "✅ Coverage is above 5% threshold (current: $COVERAGE%)"
        fi
    
    - name: Run linter and format
      working-directory: ./services/api
      run: |
        echo "🔍 格式化 Go 程式碼..."
        go fmt ./...
        echo "✅ Go 程式碼格式化完成"
        
        echo "🔍 執行 Go linter..."
        go vet ./...
        echo "✅ Go linter 完成"
    
    - name: Build backend
      working-directory: ./services/api
      run: |
        go build -o stream-demo-backend main.go

  # 前端建置測試
  frontend-build:
    runs-on: ubuntu-latest
    name: Frontend Build Test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: services/frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./services/frontend
      run: npm ci
    
    - name: Run linting
      working-directory: ./services/frontend
      run: npx eslint --config .eslintrc.cjs src --ext .vue,.js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix
    
    - name: Run type checking
      working-directory: ./services/frontend
      run: npm run build
    
    - name: Check and fix formatting
      working-directory: ./services/frontend
      run: |
        echo "🔍 檢查程式碼格式..."
        if npx prettier --check src/; then
          echo "✅ 程式碼格式正確"
        else
          echo "⚠️  發現格式問題，正在自動修復..."
          npx prettier --write src/
          echo "✅ 格式修復完成"
          
          # 檢查是否有變更需要提交
          if git diff --quiet; then
            echo "✅ 沒有需要提交的變更"
          else
            echo "📝 檢測到格式變更，正在提交..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .
            git commit -m "style: auto-format code with prettier" || echo "⚠️  提交失敗，但格式已修復"
          fi
        fi
    


  # 程式碼品質檢查
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for sensitive files
      run: |
        # 檢查是否有硬編碼的密碼
        if grep -r "password.*=" services/api/ --include="*.go" | grep -v "password.*=.*\$\{" | grep -v "test"; then
          echo "❌ Hardcoded passwords found"
          exit 1
        fi
        
        # 檢查是否有 .env 檔案被提交
        if [ -f "services/api/.env" ]; then
          echo "❌ .env file found in repository (should be in .gitignore)"
          exit 1
        fi
        
        echo "✅ No sensitive files found"
    
    - name: Check file permissions
      run: |
        # 檢查腳本是否有執行權限
        if [ -f "services/api/scripts/test.sh" ] && [ ! -x "services/api/scripts/test.sh" ]; then
          echo "❌ Test script is not executable"
          exit 1
        fi
        
        echo "✅ File permissions check passed"
    
    - name: Validate YAML files
      run: |
        # 安裝 Python yaml 模組
        python3 -m pip install pyyaml
        
        # 檢查 YAML 文件語法
        for file in $(find . -name "*.yml" -o -name "*.yaml"); do
          if [ -f "$file" ]; then
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          fi
        done
        
        echo "✅ YAML validation passed" 
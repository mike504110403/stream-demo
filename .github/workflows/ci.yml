name: CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  # å¾Œç«¯ Go æ¸¬è©¦
  backend-test:
    runs-on: ubuntu-latest
    name: Backend Tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
    
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('services/api/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Install dependencies
      working-directory: ./services/api
      run: go mod download
    
    - name: Run tests
      working-directory: ./services/api
      env:
        STREAM_DEMO_DB_HOST: localhost
        STREAM_DEMO_DB_PORT: 5432
        STREAM_DEMO_DB_USER: postgres
        STREAM_DEMO_DB_PASSWORD: postgres
        STREAM_DEMO_DB_NAME: stream_demo_test
        STREAM_DEMO_REDIS_HOST: localhost
        STREAM_DEMO_REDIS_PORT: 6379
        STREAM_DEMO_JWT_SECRET: test_jwt_secret_for_ci
        STREAM_DEMO_S3_ACCESS_KEY: test_access_key
        STREAM_DEMO_S3_SECRET_KEY: test_secret_key
        STREAM_DEMO_LIVE_API_KEY: test_live_api_key
        STREAM_DEMO_LIVE_API_SECRET: test_live_api_secret
      run: |
        go test -v -race -coverprofile=coverage.out ./...
        go tool cover -func=coverage.out
    
    - name: Check test coverage
      working-directory: ./services/api
      run: |
        COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "Current coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 5" | bc -l) )); then
          echo "âŒ Coverage is below 5% threshold (current: $COVERAGE%)"
          exit 1
        else
          echo "âœ… Coverage is above 5% threshold (current: $COVERAGE%)"
        fi
    
    - name: Run linter and format
      working-directory: ./services/api
      run: |
        echo "ðŸ” æ ¼å¼åŒ– Go ç¨‹å¼ç¢¼..."
        go fmt ./...
        echo "âœ… Go ç¨‹å¼ç¢¼æ ¼å¼åŒ–å®Œæˆ"
        
        echo "ðŸ” åŸ·è¡Œ Go linter..."
        go vet ./...
        echo "âœ… Go linter å®Œæˆ"
    
    - name: Build backend
      working-directory: ./services/api
      run: |
        go build -o stream-demo-backend main.go

  # å‰ç«¯å»ºç½®æ¸¬è©¦
  frontend-build:
    runs-on: ubuntu-latest
    name: Frontend Build Test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: services/frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./services/frontend
      run: npm ci
    
    - name: Run linting
      working-directory: ./services/frontend
      run: npx eslint --config .eslintrc.cjs src --ext .vue,.js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix
    
    - name: Run type checking
      working-directory: ./services/frontend
      run: npm run build
    
    - name: Check and fix formatting
      working-directory: ./services/frontend
      run: |
        echo "ðŸ” æª¢æŸ¥ç¨‹å¼ç¢¼æ ¼å¼..."
        if npx prettier --check src/; then
          echo "âœ… ç¨‹å¼ç¢¼æ ¼å¼æ­£ç¢º"
        else
          echo "âš ï¸  ç™¼ç¾æ ¼å¼å•é¡Œï¼Œæ­£åœ¨è‡ªå‹•ä¿®å¾©..."
          npx prettier --write src/
          echo "âœ… æ ¼å¼ä¿®å¾©å®Œæˆ"
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´éœ€è¦æäº¤
          if git diff --quiet; then
            echo "âœ… æ²’æœ‰éœ€è¦æäº¤çš„è®Šæ›´"
          else
            echo "ðŸ“ æª¢æ¸¬åˆ°æ ¼å¼è®Šæ›´ï¼Œæ­£åœ¨æäº¤..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .
            git commit -m "style: auto-format code with prettier" || echo "âš ï¸  æäº¤å¤±æ•—ï¼Œä½†æ ¼å¼å·²ä¿®å¾©"
          fi
        fi
    


  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for sensitive files
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰ç¡¬ç·¨ç¢¼çš„å¯†ç¢¼
        if grep -r "password.*=" services/api/ --include="*.go" | grep -v "password.*=.*\$\{" | grep -v "test"; then
          echo "âŒ Hardcoded passwords found"
          exit 1
        fi
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ .env æª”æ¡ˆè¢«æäº¤
        if [ -f "services/api/.env" ]; then
          echo "âŒ .env file found in repository (should be in .gitignore)"
          exit 1
        fi
        
        echo "âœ… No sensitive files found"
    
    - name: Check file permissions
      run: |
        # æª¢æŸ¥è…³æœ¬æ˜¯å¦æœ‰åŸ·è¡Œæ¬Šé™
        if [ -f "services/api/scripts/test.sh" ] && [ ! -x "services/api/scripts/test.sh" ]; then
          echo "âŒ Test script is not executable"
          exit 1
        fi
        
        echo "âœ… File permissions check passed"
    
    - name: Validate YAML files
      run: |
        # å®‰è£ Python yaml æ¨¡çµ„
        python3 -m pip install pyyaml
        
        # æª¢æŸ¥ YAML æ–‡ä»¶èªžæ³•
        for file in $(find . -name "*.yml" -o -name "*.yaml"); do
          if [ -f "$file" ]; then
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          fi
        done
        
        echo "âœ… YAML validation passed" 